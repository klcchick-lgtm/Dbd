const handleGenerateMockup = async () => {
  setIsGeneratingMockup(true);
  
  // 1. Get a technical description of the sketch from Gemini
  const sketchDescription = await callGemini(
    "Analyze this grillz sketch. List the tooth numbers involved and whether they are solid gold or iced out.", 
    canvasRef.current.toDataURL("image/png")
  );

  // 2. Build the 'Bespoke' high-res prompt
  const highResPrompt = `
    SUBJECT: A macro studio photograph of a custom ${formData.metal} ${formData.finish} grill. ${sketchDescription}. 
    DIAMOND SPECS: D-color VVS1 diamonds, brilliant-cut, intense light dispersion, sharp pavilion reflections, caustic light patterns on the gold surface.
    OPTICS: Ray-traced reflections, diffraction spikes, 8k resolution, focus stacking to ensure every diamond facet is sharp.
    ENVIRONMENT: Softbox lighting with black velvet background, high contrast, professional jewelry photography style.
    CAMERA: Sony A7R IV, 90mm Macro Lens, f/11 aperture for deep focus.
  `;

  try {
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-001:predict?key=${apiKey}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        instances: [{ prompt: highResPrompt }],
        parameters: { 
          sampleCount: 1,
          aspectRatio: "1:1",
          safetySetting: "BLOCK_MEDIUM_AND_ABOVE",
          // Requesting enhanced detail for gemstone facets
          enhancePrompt: false 
        }
      })
    });
    
    const result = await response.json();
    const b64 = result.predictions?.[0]?.bytesBase64Encoded;
    if (b64) setMockupUrl(`data:image/png;base64,${b64}`);
  } catch (e) {
    console.error("Mockup generation failed", e);
  } finally {
    setIsGeneratingMockup(false);
  }
};
