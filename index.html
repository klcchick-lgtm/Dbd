import React, { useState, useRef, useEffect } from 'react';
import { 
  Eraser, PenTool, Trash2, Download, Send, RefreshCw, 
  Check, Phone, User, Mail, Sparkles, Gem, BrainCircuit, 
  Wand2, DollarSign, Loader2, Volume2, Camera, TrendingUp, X,
  MessageSquare, Image as ImageIcon, Globe, Search, Layers, ShieldCheck,
  Star, Quote, Zap, Terminal, History, Info, Award, FileText
} from 'lucide-react';

/**
 * DBD Jewelry, LLC - Imperial Atelier Designer
 * Featuring Gemini AI for Design Evolution & Market Grounding
 */

const apiKey = "YOUR_GEMINI_API_KEY"; // Replace with your secure API key

// --- Audio Utility ---
const pcmToWav = (pcmData, sampleRate) => {
  const buffer = new ArrayBuffer(44 + pcmData.length * 2);
  const view = new DataView(buffer);
  const writeString = (offset, string) => {
    for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
  };
  writeString(0, 'RIFF');
  view.setUint32(4, 36 + pcmData.length * 2, true);
  writeString(8, 'WAVE');
  writeString(12, 'fmt ');
  view.setUint32(16, 16, true);
  view.setUint16(20, 1, true);
  view.setUint16(22, 1, true);
  view.setUint32(24, sampleRate, true);
  view.setUint32(28, sampleRate * 2, true);
  view.setUint16(32, 2, true);
  view.setUint16(34, 16, true);
  writeString(36, 'data');
  view.setUint32(40, pcmData.length * 2, true);
  let offset = 44;
  for (let i = 0; i < pcmData.length; i++, offset += 2) view.setInt16(offset, pcmData[i], true);
  return new Blob([buffer], { type: 'audio/wav' });
};

const App = () => {
  const [view, setView] = useState('editor');
  const [orderData, setOrderData] = useState(null);

  const handleOrderSubmit = (data, image) => {
    setOrderData({ ...data, image });
    setView('success');
  };

  return (
    <div className="min-h-screen bg-neutral-950 text-amber-50 font-sans selection:bg-amber-500 selection:text-black">
      {view === 'editor' ? (
        <EditorView onSubmit={handleOrderSubmit} />
      ) : (
        <SuccessView data={orderData} onReset={() => setView('editor')} />
      )}
    </div>
  );
};

// --- Main Editor View ---

const EditorView = ({ onSubmit }) => {
  const canvasRef = useRef(null);
  const audioRef = useRef(new Audio());
  const chatEndRef = useRef(null);

  const [isDrawing, setIsDrawing] = useState(false);
  const [brushColor, setBrushColor] = useState('#FFD700');
  const [tool, setTool] = useState('brush');
  
  // AI States
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [aiFeedback, setAiFeedback] = useState("");
  const [isEstimating, setIsEstimating] = useState(false);
  const [priceEstimate, setPriceEstimate] = useState(null);
  const [isSpeaking, setIsSpeaking] = useState(false);
  const [isGeneratingMockup, setIsGeneratingMockup] = useState(false);
  const [mockupUrl, setMockupUrl] = useState(null);
  const [isEvolving, setIsEvolving] = useState(false);
  const [isMatchingCelebs, setIsMatchingCelebs] = useState(false);
  const [celebMatch, setCelebMatch] = useState("");
  const [isNaming, setIsNaming] = useState(false);
  const [isMappingIce, setIsMappingIce] = useState(false);
  const [iceMap, setIceMap] = useState("");
  const [isOrchestrating, setIsOrchestrating] = useState(false);
  const [commandInput, setCommandInput] = useState("");
  const [showCommandBar, setShowCommandBar] = useState(false);
  
  // Chat
  const [isChatOpen, setIsChatOpen] = useState(false);
  const [expert, setExpert] = useState('Aurora'); 
  const [chatMessages, setChatMessages] = useState([
    { role: 'ai', sender: 'Aurora', text: "Welcome to DBD Jewelry. I am Aurora. Shall we design your legacy today?" }
  ]);
  const [currentChatInput, setCurrentChatInput] = useState("");
  const [isChatLoading, setIsChatLoading] = useState(false);

  // Form
  const [formData, setFormData] = useState({
    name: '', phone: '', email: '',
    designTitle: '', designLore: '',
    metal: '14k Yellow Gold', finish: 'High Polish', notes: ''
  });

  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    const ctx = canvas.getContext('2d');
    ctx.scale(dpr, dpr);
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
  }, []);

  // --- AI Logic Integration ---

  const callGemini = async (prompt, imageData = null, config = {}, model = "gemini-2.0-flash") => {
    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }, ...(imageData ? [{ inlineData: { mimeType: "image/png", data: imageData.split(',')[1] } }] : [])] }],
          ...config
        })
      });
      const result = await response.json();
      return result.candidates?.[0]?.content?.parts?.[0]?.text;
    } catch (err) {
      console.error("Gemini API Error:", err);
      return "Communication with the atelier was interrupted.";
    }
  };

  const handleSpeak = async (text, speakerName = "Aurora") => {
    if (!text || isSpeaking) return;
    setIsSpeaking(true);
    const voice = speakerName === "Aurora" ? "Aoede" : "Charon";
    try {
      // Logic for Gemini TTS implementation...
      setIsSpeaking(false);
    } catch (e) { setIsSpeaking(false); }
  };

  const handleDesignOrchestrator = async (e) => {
    e.preventDefault();
    if (!commandInput.trim()) return;
    setIsOrchestrating(true);
    const prompt = `User Command: "${commandInput}". Update this JSON: ${JSON.stringify(formData)}. Return ONLY updated JSON.`;
    try {
      const res = await callGemini(prompt, null, { generationConfig: { responseMimeType: "application/json" } });
      const updates = JSON.parse(res);
      setFormData(prev => ({ ...prev, ...updates }));
      setCommandInput("");
      setShowCommandBar(false);
    } catch (e) { console.error(e); } finally { setIsOrchestrating(false); }
  };

  // --- Drawing Logic ---
  const startDrawing = (e) => {
    const ctx = canvasRef.current.getContext('2d');
    const rect = canvasRef.current.getBoundingClientRect();
    const pos = e.touches ? e.touches[0] : e;
    ctx.beginPath(); 
    ctx.moveTo(pos.clientX - rect.left, pos.clientY - rect.top);
    setIsDrawing(true);
  };

  const draw = (e) => {
    if (!isDrawing) return;
    const ctx = canvasRef.current.getContext('2d');
    const rect = canvasRef.current.getBoundingClientRect();
    const pos = e.touches ? e.touches[0] : e;
    if (tool === 'eraser') {
      ctx.globalCompositeOperation = 'destination-out';
      ctx.lineWidth = 20;
    } else {
      ctx.globalCompositeOperation = 'source-over';
      ctx.strokeStyle = brushColor;
      ctx.lineWidth = 3;
    }
    ctx.lineTo(pos.clientX - rect.left, pos.clientY - rect.top);
    ctx.stroke();
  };

  return (
    <div className="flex flex-col lg:flex-row h-screen max-w-[1600px] mx-auto p-4 gap-4 overflow-hidden">
      
      {/* Sidebar Controls */}
      <div className="hidden lg:flex flex-col w-20 gap-4 shrink-0">
        <div className="bg-neutral-900 border border-amber-900/20 p-4 rounded-3xl flex flex-col items-center gap-6 shadow-2xl h-full">
          <div className="w-12 h-12 bg-amber-500 rounded-2xl flex items-center justify-center text-black shadow-lg"><Gem size={24}/></div>
          
          <NavIcon icon={<Star size={22}/>} label="Celeb Inspo" onClick={async () => {
            setIsMatchingCelebs(true);
            const res = await callGemini("Who wears grillz like this?", canvasRef.current.toDataURL());
            setCelebMatch(res); setIsMatchingCelebs(false);
          }} loading={isMatchingCelebs} />

          <NavIcon icon={<History size={22}/>} label="Heritage" onClick={async () => {
            setIsAnalyzing(true);
            const res = await callGemini("Explain the cultural significance of this design.", canvasRef.current.toDataURL());
            setAiFeedback(res); setIsAnalyzing(false);
          }} loading={isAnalyzing} />

          <div className="mt-auto">
            <button onClick={() => setIsChatOpen(true)} className="p-4 bg-neutral-800 rounded-2xl text-amber-500 hover:bg-amber-500 hover:text-black transition-all">
              <MessageSquare size={24}/>
            </button>
          </div>
        </div>
      </div>

      {/* Main Designer Canvas */}
      <div className="flex-grow flex flex-col gap-4 overflow-y-auto custom-scrollbar pr-2">
        <header className="bg-neutral-900/60 backdrop-blur-md border border-white/5 p-6 rounded-[2rem] flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-serif text-amber-400 tracking-widest uppercase">DBD Jewelry</h1>
            <p className="text-[9px] text-neutral-500 font-bold uppercase tracking-[0.4em]">Custom Grillz Atelier</p>
          </div>
          <button onClick={() => setShowCommandBar(!showCommandBar)} className="px-6 py-2 bg-amber-500/10 border border-amber-500/30 rounded-full text-amber-500 text-[10px] font-black uppercase flex items-center gap-2 hover:bg-amber-500 hover:text-black transition-all">
            <Terminal size={14}/> Design Command
          </button>
        </header>

        {showCommandBar && (
          <form onSubmit={handleDesignOrchestrator} className="bg-neutral-900 border border-amber-500/30 p-4 rounded-2xl flex gap-4 animate-in slide-in-from-top-2">
            <input autoFocus className="flex-grow bg-transparent outline-none text-sm" placeholder="e.g. 'Make it 18k White Gold with Diamond Dust'" value={commandInput} onChange={e => setCommandInput(e.target.value)} />
            <button type="submit" className="text-amber-500">{isOrchestrating ? <Loader2 className="animate-spin"/> : <Send size={20}/>}</button>
          </form>
        )}

        <div className="grid grid-cols-1 xl:grid-cols-12 gap-4 flex-grow">
          <div className="xl:col-span-8 relative bg-neutral-900 border border-amber-900/20 rounded-[3rem] overflow-hidden min-h-[500px]">
            <div className="absolute inset-0 opacity-10 pointer-events-none p-20"><TeethSVG /></div>
            <canvas ref={canvasRef} className="absolute inset-0 w-full h-full cursor-crosshair z-10" onMouseDown={startDrawing} onMouseMove={draw} onMouseUp={() => setIsDrawing(false)} />
            
            {/* Toolbar Overlay */}
            <div className="absolute bottom-8 left-1/2 -translate-x-1/2 bg-neutral-950/90 border border-white/10 px-6 py-3 rounded-full flex items-center gap-6 z-30 shadow-2xl">
              <div className="flex gap-3 pr-6 border-r border-neutral-800">
                <ColorBtn color="#FFD700" active={brushColor === '#FFD700'} onClick={() => {setBrushColor('#FFD700'); setTool('brush');}} />
                <ColorBtn color="#E3E4E6" active={brushColor === '#E3E4E6'} onClick={() => {setBrushColor('#E3E4E6'); setTool('brush');}} />
                <ColorBtn color="#B76E79" active={brushColor === '#B76E79'} onClick={() => {setBrushColor('#B76E79'); setTool('brush');}} />
              </div>
              <button onClick={() => setTool('eraser')} className={`p-2 ${tool === 'eraser' ? 'text-red-400' : 'text-neutral-500'}`}><Eraser size={20}/></button>
              <button onClick={() => canvasRef.current.getContext('2d').clearRect(0,0,2000,2000)} className="p-2 text-neutral-500 hover:text-red-400"><Trash2 size={20}/></button>
            </div>

            {/* AI Action Buttons */}
            <div className="absolute top-8 right-8 flex flex-col gap-3 z-30">
              <AiActionBtn onClick={() => {}} icon={<ImageIcon size={20}/>} label="Gen Mockup" color="amber" />
              <AiActionBtn onClick={async () => {
                setIsEstimating(true);
                const res = await callGemini("Price this custom gold piece.", canvasRef.current.toDataURL());
                setPriceEstimate(res); setIsEstimating(false);
              }} icon={<DollarSign size={20}/>} label="Live Quote" color="blue" loading={isEstimating} />
            </div>
          </div>

          {/* Right Panel: Order Info */}
          <div className="xl:col-span-4 bg-neutral-900 border border-white/5 rounded-[3rem] p-8 flex flex-col gap-6 shadow-xl">
             <h3 className="font-serif text-xl text-amber-100 italic border-b border-white/5 pb-4">Order Blueprint</h3>
             <div className="flex flex-col gap-4">
               <label className="text-[10px] uppercase font-black tracking-widest text-amber-600">Client Name</label>
               <input className="w-full bg-neutral-950 border border-neutral-800 rounded-2xl px-5 py-3 text-sm focus:border-amber-500 outline-none" placeholder="John Doe" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
               
               <div className="grid grid-cols-2 gap-4">
                 <div className="flex flex-col gap-2">
                   <label className="text-[10px] uppercase font-black tracking-widest text-amber-600">Metal</label>
                   <select className="bg-neutral-950 border border-neutral-800 rounded-xl p-3 text-xs outline-none" value={formData.metal} onChange={e => setFormData({...formData, metal: e.target.value})}>
                     <option>14k Yellow Gold</option><option>18k Yellow Gold</option><option>Platinum</option>
                   </select>
                 </div>
                 <div className="flex flex-col gap-2">
                   <label className="text-[10px] uppercase font-black tracking-widest text-amber-600">Finish</label>
                   <select className="bg-neutral-950 border border-neutral-800 rounded-xl p-3 text-xs outline-none" value={formData.finish} onChange={e => setFormData({...formData, finish: e.target.value})}>
                     <option>High Polish</option><option>Diamond Dust</option><option>Deep Cuts</option>
                   </select>
                 </div>
               </div>

               <label className="text-[10px] uppercase font-black tracking-widest text-amber-600">Technical Notes</label>
               <textarea className="w-full bg-neutral-950 border border-neutral-800 rounded-2xl p-5 text-sm min-h-[120px] resize-none outline-none focus:border-amber-500" placeholder="Describe diamond placement..." value={formData.notes} onChange={e => setFormData({...formData, notes: e.target.value})} />
               
               {priceEstimate && (
                 <div className="p-4 bg-emerald-500/5 border border-emerald-500/20 rounded-2xl text-[11px] text-emerald-200 leading-relaxed italic">
                   {priceEstimate}
                 </div>
               )}

               <button onClick={() => onSubmit(formData, canvasRef.current.toDataURL())} className="w-full bg-amber-500 py-4 rounded-2xl text-black font-black uppercase text-xs tracking-widest mt-4 hover:bg-amber-400 transition-all">
                 Finalize Selection
               </button>
             </div>
          </div>
        </div>
      </div>

      {/* Chat Component Placeholder */}
      {isChatOpen && (
        <div className="fixed inset-y-0 right-0 w-96 bg-neutral-900 border-l border-white/5 z-50 flex flex-col shadow-[-50px_0_100px_rgba(0,0,0,0.5)] animate-in slide-in-from-right-full">
          <div className="p-6 border-b border-white/5 flex justify-between items-center">
            <h4 className="font-serif italic text-amber-500">Atelier Consultant</h4>
            <button onClick={() => setIsChatOpen(false)}><X/></button>
          </div>
          <div className="flex-grow p-6 overflow-y-auto">
            {chatMessages.map((m, i) => (
              <div key={i} className={`mb-4 ${m.role === 'ai' ? 'text-left' : 'text-right'}`}>
                <div className={`inline-block p-4 rounded-2xl text-xs max-w-[80%] ${m.role === 'ai' ? 'bg-neutral-800 text-amber-50' : 'bg-amber-500 text-black font-bold'}`}>
                  {m.text}
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
};

// --- Success View ---

const SuccessView = ({ data, onReset }) => (
  <div className="h-screen flex items-center justify-center p-6 text-center">
    <div className="max-w-2xl bg-neutral-900 border border-amber-500/20 p-12 rounded-[4rem] shadow-2xl">
      <div className="w-20 h-20 bg-emerald-500/20 text-emerald-400 rounded-full flex items-center justify-center mx-auto mb-8 border border-emerald-500/30">
        <Check size={40} />
      </div>
      <h2 className="text-4xl font-serif text-amber-50 mb-4">Design Transmitted</h2>
      <p className="text-neutral-500 text-sm mb-10 leading-relaxed">
        The artisan team at **DBD Jewelry, LLC** has received your blueprint for {data.name}. We will review the specs for {data.metal} and contact you shortly.
      </p>
      <button onClick={onReset} className="px-10 py-4 bg-amber-500 text-black font-black rounded-full uppercase text-xs tracking-[0.2em]">Start New Commission</button>
    </div>
  </div>
);

// --- Small UI Helpers ---

const NavIcon = ({ icon, label, onClick, loading }) => (
  <button onClick={onClick} className="p-3 text-neutral-500 hover:text-amber-500 transition-all relative group">
    {loading ? <Loader2 className="animate-spin"/> : icon}
    <span className="absolute left-full ml-4 bg-black text-[10px] px-3 py-1 rounded opacity-0 group-hover:opacity-100 whitespace-nowrap z-50">{label}</span>
  </button>
);

const ColorBtn = ({ color, active, onClick }) => (
  <button onClick={onClick} className={`w-6 h-6 rounded-full border-2 transition-transform ${active ? 'border-white scale-125 shadow-lg' : 'border-transparent'}`} style={{ backgroundColor: color }} />
);

const AiActionBtn = ({ onClick, icon, label, color, loading }) => (
  <button onClick={onClick} className={`p-4 rounded-2xl border bg-black/50 backdrop-blur-md transition-all flex flex-col items-center gap-1 group border-white/5 hover:border-amber-500/50`}>
    {loading ? <Loader2 size={20} className="animate-spin text-amber-500"/> : icon}
    <span className="text-[8px] uppercase font-black tracking-tighter opacity-0 group-hover:opacity-100">{label}</span>
  </button>
);

const TeethSVG = () => (
  <svg viewBox="0 0 500 200" className="w-full h-full text-neutral-800 fill-none stroke-current" strokeWidth="2">
    <path d="M100,50 Q250,20 400,50 L400,100 Q250,130 100,100 Z" />
    <line x1="150" y1="35" x2="150" y2="115" />
    <line x1="200" y1="28" x2="200" y2="125" />
    <line x1="250" y1="25" x2="250" y2="128" />
    <line x1="300" y1="28" x2="300" y2="125" />
    <line x1="350" y1="35" x2="350" y2="115" />
  </svg>
);

export default App;
